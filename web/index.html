<!DOCTYPE html>
<html>

<head>
  <base href="/">
  <meta charset="UTF-8">
  <meta name="description" content="Khangmate - Property Rental Platform">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme-color" content="#0175C2">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Khangmate">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png" />
  <title>Khangmate</title>
  <link rel="manifest" href="manifest.json">

  <!-- Supabase Client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase with your credentials
    const supabaseUrl = 'https://igoqdbuwnyxdnszcubqe.supabase.co';
    const supabaseAnonKey = 'YeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlnb3FkYnV3bnl4ZG5zemN1YnFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MDY2NzksImV4cCI6MjA3NjQ4MjY3OX0.8sjtyFFwl3tYMAi3X8M8BGLP88DWOYviGfNbMtu2Jk0'


    if (supabaseUrl && supabaseUrl !== 'YOUR_SUPABASE_URL' &&
      supabaseAnonKey && supabaseAnonKey !== 'YOUR_SUPABASE_ANON_KEY') {
      window.supabase = supabase.createClient(supabaseUrl, supabaseAnonKey, {
        auth: {
          autoRefreshToken: true,
          persistSession: true,
          detectSessionInUrl: true
        }
      });
    } else {
      console.warn('Supabase credentials not configured. Please update supabaseUrl and supabaseAnonKey in index.html');
    }
  </script>

  <style>
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      background-color: #f8f9fa;
      position: fixed;
      z-index: 9999;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
  </div>

  <div id="error"
    style="display: none; position: fixed; top: 0; left: 0; right: 0; background: #ffebee; color: #b71c1c; padding: 1rem; z-index: 10000; text-align: center;">
  </div>

  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('flutter_service_worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
            // After service worker is registered, initialize Flutter
            initializeFlutterApp();
          })
          .catch(error => {
            console.error('ServiceWorker registration failed:', error);
            // Even if service worker fails, try to initialize Flutter
            initializeFlutterApp();
          });
      });
    } else {
      // If service workers are not supported, just initialize Flutter
      window.addEventListener('load', initializeFlutterApp);
    }

    // Flutter App Initialization
    function initializeFlutterApp() {
      // Simple initialization without service worker version
      _flutter.loader.loadEntrypoint({
        onEntrypointLoaded: async (engineInitializer) => {
          try {
            const appRunner = await engineInitializer.initializeEngine();
            await appRunner.runApp();

            // Hide loading indicator when Flutter is ready
            const loading = document.getElementById('loading');
            if (loading) {
              loading.style.display = 'none';
            }
          } catch (error) {
            console.error('Failed to start Flutter app:', error);
            showError('Failed to start the application. Please try refreshing the page.');
          }
        }
      });
    }

    // Global error handler
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error || event.message || event);
      showError('An unexpected error occurred. Please try refreshing the page.');
    });

    // Utility function to show error messages
    function showError(message) {
      const errorDiv = document.getElementById('error');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }
    }
  </script>

  <!-- Flutter entry point -->
  <script src="flutter.js" defer></script>
</body>

</html>